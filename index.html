<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>事業管理</title>
    <link rel="icon" type="image/png" href="Tasks.png">
    <link rel="apple-touch-icon" href="Tasks.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app" class="app-container">
        <!-- コンテンツはJavaScriptで動的に挿入されます -->
    </div>

    <!-- テンプレート: ホーム画面 -->
    <template id="home-template">
        <div class="document">
            <header class="document-header">
                <h1 class="document-title">事業管理</h1>
                <p class="document-subtitle">協業×自動化の圧倒的スピードで多数同時展開</p>
                <div class="document-date">最終更新: <span id="last-updated-date"></span></div>
                <div class="account-menu">
                    <button id="account-btn"><i class="fas fa-user"></i><span id="account-email"></span></button>
                    <ul id="account-dropdown" class="account-dropdown hidden">
                        <li id="account-status">ゲスト</li>
                        <li><a href="#" id="dropdown-login">ログイン</a></li>
                        <li><a href="#" id="dropdown-logout">ログアウト</a></li>
                    </ul>
                </div>
            </header>
            
            <nav class="document-nav">
                <h2 class="nav-title">目次</h2>
                <ul class="nav-links">
                    <li><a href="#" data-page="home" class="nav-link active">ホーム</a></li>
                    <li><a href="#" data-page="daily-tasks" class="nav-link">今日のタスク</a></li>
                    <li><a href="#" data-page="kpi-list" class="nav-link">KPI一覧</a></li>
                </ul>
            </nav>
            
            <main class="document-body">
                <section id="summary" class="document-section">
                    <h2 class="section-title">計画概要</h2>
                    
                    <div class="summary-box">
                        <h3 class="summary-title">事業計画の全体像</h3>
                        <p class="summary-content">収益性は考えず思いついたものをどんどん追加する。1日中高速で取り組んでも時間が足りない状況になった場合は、自動化したり組織化したり要員を集める。見かけたもの全て半日あったら丸パクリできる！！！嫌いな奴らを餌で釣って中毒にして人生破壊して搾取する。</p>
                    </div>
                    
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="short-term-count">10</div>
                            <div class="stat-label">短期事業（3日以内）</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="long-term-count">5</div>
                            <div class="stat-label">長期事業（時期不明）</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="in-progress-count">0</div>
                            <div class="stat-label">進行中事業</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="completed-count">0</div>
                            <div class="stat-label">完了済み事業</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="total-count">19</div>
                            <div class="stat-label">合計事業数</div>
                        </div>
                    </div>
                </section>
                
                <section id="in-progress" class="document-section">
                    <h2 class="section-title">進行中の事業（進捗度20%以上）</h2>
                    
                    <div class="timeline-container">
                        <div class="timeline-line"></div>
                        <div class="timeline-group">
                            <div class="timeline-marker in-progress"></div>
                            <div class="timeline-cards" id="in-progress-cards">
                                <!-- 進行中の事業カードがここに動的に挿入されます -->
                            </div>
                        </div>
                    </div>
                </section>
                
                <section id="short-term" class="document-section">
                    <h2 class="section-title">短期計画（3日以内に開始）</h2>
                    
                    <div class="timeline-container">
                        <div class="timeline-line"></div>
                        <div class="timeline-group">
                            <div class="timeline-marker short-term"></div>
                            <div class="timeline-cards" id="short-term-cards">
                                <!-- 短期的な事業カードがここに動的に挿入されます -->
                            </div>
                        </div>
                    </div>
                </section>
                
                <section id="long-term" class="document-section">
                    <h2 class="section-title">長期計画（時期不明）</h2>

                    <div class="timeline-container">
                        <div class="timeline-line"></div>
                        <div class="timeline-group">
                            <div class="timeline-marker long-term"></div>
                            <div class="timeline-cards" id="long-term-cards">
                                <!-- 長期的な事業カードがここに動的に挿入されます -->
                            </div>
                        </div>
                    </div>
                </section>
                
                <section id="completed" class="document-section">
                    <h2 class="section-title">完了済み事業</h2>
                    
                    <div class="timeline-container">
                        <div class="timeline-line"></div>
                        <div class="timeline-group">
                            <div class="timeline-marker completed"></div>
                            <div class="timeline-cards" id="completed-cards">
                                <!-- 完了済み事業カードがここに動的に挿入されます -->
                            </div>
                        </div>
                    </div>
                </section>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color short-term"></div>
                        <span class="legend-label">短期計画：3日以内に開始</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color long-term"></div>
                        <span class="legend-label">長期計画：時期不明</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color in-progress"></div>
                        <span class="legend-label">進行中：進捗度20%以上</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color completed"></div>
                        <span class="legend-label">完了済み：進捗度100%</span>
                    </div>
                </div>
            </main>
            
            <footer class="document-footer">
                <div class="footer-copyright">© 2025 事業・活動進捗管理</div>
                <div class="footer-updated">最終更新：<span id="footer-last-updated"></span></div>
            </footer>

            <button id="add-activity-btn" class="floating-btn">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </template>

    <!-- テンプレート: 活動詳細画面 -->
    <template id="activity-detail-template">
        <div class="document fullscreen-detail">
            <header class="document-header detail-header">
                <div class="back-button">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="header-content">
                    <h1 class="document-title" id="detail-activity-name"></h1>
                    <div class="header-last-updated">最終更新: <span id="detail-last-updated"></span></div>
                </div>
            </header>
            
            <main class="document-body">
                <div class="detail-content">
                    <div class="detail-progress-container">
                        <h3>進捗状況</h3>
                        <div class="detail-progress-wrapper">
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="detail-progress-bar"></div>
                            </div>
                            <div class="progress-percentage" id="detail-progress-percentage">0%</div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-section-header">
                            <h3>KPI</h3>
                            <button class="add-item-btn kpi-add-detail-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="kpi-list" class="detail-list">
                            <!-- KPIがここに動的に挿入されます -->
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-section-header">
                            <h3>フェーズ</h3>
                            <button class="add-item-btn phase-add-detail-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="phases-list" class="phases-container">
                            <!-- フェーズがここに動的に挿入されます -->
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-section-header">
                            <h3>毎日のタスク</h3>
                            <button class="add-item-btn task-add-detail-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="daily-tasks-list" class="detail-list">
                            <!-- 毎日のタスクがここに動的に挿入されます -->
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <h3>備考</h3>
                        </div>
                        <div class="notes-container">
                            <div id="notes-editor" class="notes-editor" contenteditable="true"></div>
                            <button id="save-notes-btn" class="save-notes-btn">保存</button>
                        </div>
                    </div>
                </div>
            </main>
            
            <footer class="document-footer">
                <div class="footer-copyright">© 2025 事業・活動進捗管理</div>
                <div class="footer-updated">最終更新：<span id="detail-footer-last-updated"></span></div>
            </footer>

            <div class="floating-buttons">
                <!-- 完了ボタンを削除 -->
                <button id="delete-activity-btn" class="floating-btn delete-btn">
                    <i class="fas fa-trash"></i>
                </button>
                <button id="edit-activity-btn" class="floating-btn edit-btn">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- テンプレート: 今日のタスク画面 -->
    <template id="daily-tasks-template">
        <div class="document">
            <header class="document-header">
                <h1 class="document-title">今日のタスク</h1>
                <p class="document-subtitle">すべての事業の毎日のタスク一覧</p>
                <div class="document-date">日付: <span id="current-date"></span></div>
            </header>
            
            <nav class="document-nav">
                <h2 class="nav-title">目次</h2>
                <ul class="nav-links">
                    <li><a href="#" data-page="home" class="nav-link">ホーム</a></li>
                    <li><a href="#" data-page="daily-tasks" class="nav-link active">今日のタスク</a></li>
                    <li><a href="#" data-page="kpi-list" class="nav-link">KPI一覧</a></li>
                </ul>
            </nav>
            
            <main class="document-body">
                <div class="tasks-filter">
                    <button class="filter-btn active" data-filter="all">すべて</button>
                    <button class="filter-btn" data-filter="pending">未完了</button>
                    <button class="filter-btn" data-filter="completed">完了</button>
                </div>

                <div class="task-completion-summary">
                    <div class="completion-progress">
                        <div class="completion-bar-container">
                            <div class="completion-bar" id="completion-progress-bar"></div>
                        </div>
                        <div class="completion-text">
                            <span id="task-completed-count">0</span>/<span id="total-task-count">0</span> タスク完了
                        </div>
                    </div>
                </div>

                <div class="tasks-container" id="daily-tasks-container">
                    <!-- タスクがここに動的に挿入されます -->
                </div>
            </main>
            
            <footer class="document-footer">
                <div class="footer-copyright">© 2025 事業・活動進捗管理</div>
                <div class="footer-updated">最終更新：<span id="tasks-footer-last-updated"></span></div>
            </footer>
        </div>
    </template>

    <!-- テンプレート: KPI一覧画面 -->
    <template id="kpi-list-template">
        <div class="document">
            <header class="document-header">
                <h1 class="document-title">KPI一覧</h1>
                <p class="document-subtitle">全事業のKPI進捗状況</p>
                <div class="document-date">日付: <span id="kpi-current-date"></span></div>
            </header>
            
            <nav class="document-nav">
                <h2 class="nav-title">目次</h2>
                <ul class="nav-links">
                    <li><a href="#" data-page="home" class="nav-link">ホーム</a></li>
                    <li><a href="#" data-page="daily-tasks" class="nav-link">今日のタスク</a></li>
                    <li><a href="#" data-page="kpi-list" class="nav-link active">KPI一覧</a></li>
                </ul>
            </nav>
            
            <main class="document-body">
                <div class="kpi-filter">
                    <button class="filter-btn active" data-filter="all">すべて</button>
                    <button class="filter-btn" data-filter="pending">未達成</button>
                    <button class="filter-btn" data-filter="completed">達成済み</button>
                </div>

                <div class="kpi-completion-summary">
                    <div class="completion-progress">
                        <div class="completion-bar-container">
                            <div class="completion-bar" id="kpi-completion-progress-bar"></div>
                        </div>
                        <div class="completion-text">
                            <span id="kpi-completed-count">0</span>/<span id="total-kpi-count">0</span> KPI達成
                        </div>
                    </div>
                </div>

                <div class="kpi-container" id="kpi-list-container">
                    <!-- KPIがここに動的に挿入されます -->
                </div>
            </main>
            
            <footer class="document-footer">
                <div class="footer-copyright">© 2025 事業・活動進捗管理</div>
                <div class="footer-updated">最終更新：<span id="kpi-footer-last-updated"></span></div>
            </footer>
        </div>
    </template>

    <!-- テンプレート: 活動追加/編集画面 -->
    <template id="activity-form-template">
        <div class="document">
            <header class="document-header detail-header">
                <div class="back-button">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="header-content">
                    <h1 class="document-title" id="form-title">新規事業追加</h1>
                    <p class="document-subtitle">詳細情報を入力してください</p>
                </div>
            </header>
            
            <main class="document-body">
                <form id="activity-form" class="activity-form">
                    <div class="form-group">
                        <label for="activity-name">事業名</label>
                        <input type="text" id="activity-name" required>
                    </div>

                    <div class="form-group">
                        <label for="activity-timeline">期間</label>
                        <select id="activity-timeline" required>
                            <option value="short-term">短期（3日以内）</option>
                            <option value="long-term">長期（時期不明）</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>KPI</label>
                        <div id="kpi-inputs" class="dynamic-inputs">
                            <div class="input-group kpi-input-group">
                                <input type="text" class="kpi-input" placeholder="KPI" required>
                                <input type="date" class="kpi-date-input" required>
                                <select class="kpi-assignee-select assignee-select">
                                    <option value="yu">ゆちゃん</option>
                                    <option value="saki">さきたん</option>
                                    <option value="both" selected>ゆちゃんorさきたん</option>
                                </select>
                                <button type="button" class="add-item-btn kpi-add-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>フェーズ</label>
                        <div id="phase-inputs" class="dynamic-inputs">
                            <div class="input-group">
                                <input type="text" class="phase-input" placeholder="フェーズ">
                                <button type="button" class="add-item-btn phase-add-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>毎日のタスク</label>
                        <div id="task-inputs" class="dynamic-inputs">
                            <div class="input-group task-input-group">
                                <input type="text" class="task-input" placeholder="タスク">
                                <select class="task-assignee-select assignee-select">
                                    <option value="yu">ゆちゃん</option>
                                    <option value="saki">さきたん</option>
                                    <option value="both" selected>ゆちゃんorさきたん</option>
                                </select>
                                <button type="button" class="add-item-btn task-add-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="activity-progress">現在の進捗 (%)</label>
                        <input type="number" id="activity-progress" min="0" max="100" value="0">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="submit-btn">保存</button>
                        <button type="button" class="cancel-btn">キャンセル</button>
                    </div>
                </form>
            </main>
            
            <footer class="document-footer">
                <div class="footer-copyright">© 2025 事業・活動進捗管理</div>
            </footer>
        </div>
    </template>
    <!-- Firebase 初期化と Firestore + Auth の設定 -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
      import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCCmNMhbz1G35de_AkkebVW53xAZc1kYwI",
        authDomain: "pinomaro-managing.firebaseapp.com",
        projectId: "pinomaro-managing",
        storageBucket: "pinomaro-managing.firebasestorage.app",
        messagingSenderId: "619245174856",
        appId: "1:619245174856:web:625820f7a35f7a80b0d87d",
        measurementId: "G-8LN2271RCQ"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      let accountBtn, accountDropdown, accountStatus, accountEmail, loginLink, logoutLink;

      function updateAccountUI(user) {
        if (!accountStatus || !loginLink || !logoutLink || !accountEmail) return;
        if (user) {
          const email = user.email || `${user.displayName || 'ユーザー'}`;
          accountStatus.textContent = email;
          accountEmail.textContent = email;
          loginLink.style.display = 'none';
          logoutLink.style.display = 'block';
        } else {
          accountStatus.textContent = 'ゲスト';
          accountEmail.textContent = '';
          loginLink.style.display = 'block';
          logoutLink.style.display = 'none';
        }
      }

      window.initAccountMenu = function() {
        accountBtn = document.getElementById('account-btn');
        accountDropdown = document.getElementById('account-dropdown');
        accountStatus = document.getElementById('account-status');
        accountEmail = document.getElementById('account-email');
        loginLink = document.getElementById('dropdown-login');
        logoutLink = document.getElementById('dropdown-logout');

        if (!accountBtn) return;

        accountBtn.addEventListener('click', () => {
          accountDropdown.classList.toggle('hidden');
        });

        if (!window.__accountMenuOutsideListener) {
          window.__accountMenuOutsideListener = (e) => {
            if (!accountBtn.contains(e.target) && !accountDropdown.contains(e.target)) {
              accountDropdown.classList.add('hidden');
            }
          };
          document.addEventListener('click', window.__accountMenuOutsideListener);
        }

        loginLink.addEventListener('click', (e) => {
          e.preventDefault();
          signInWithPopup(auth, provider).catch(err => console.error('login error:', err));
        });

        logoutLink.addEventListener('click', (e) => {
          e.preventDefault();
          signOut(auth).catch(err => console.error('logout error:', err));
        });

        updateAccountUI(window.__currentUser);
      };

      onAuthStateChanged(auth, user => {
        window.__currentUser = user;
        updateAccountUI(user);
        if (user) {
          if (typeof window.onUserLogin === 'function') {
            window.onUserLogin(user.uid);
          }
        } else {
          if (typeof window.onUserLogout === 'function') {
            window.onUserLogout();
          }
        }
      });

      // 端末ID（自己エコーバック防止）
      const DEVICE_ID_KEY = "be-trillion-device-id";
      if (!localStorage.getItem(DEVICE_ID_KEY)) {
        const uuid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2));
        localStorage.setItem(DEVICE_ID_KEY, uuid);
      }
      const DEVICE_ID = localStorage.getItem(DEVICE_ID_KEY);

      function ensureUserId(uid) {
        if (!uid || typeof uid !== "string") throw new Error("Invalid userId");
        return uid;
      }

      // 全体保存
      window.saveData = async function(userId, state) {
        const uid = ensureUserId(userId);
        const payload = {
          ...state,
          _meta: { updatedAt: Date.now(), deviceId: DEVICE_ID }
        };
        await setDoc(doc(db, "users", uid), payload);
        return payload._meta;
      };

      // 一回読み込み
      window.loadData = async function(userId) {
        const uid = ensureUserId(userId);
        const snap = await getDoc(doc(db, "users", uid));
        if (snap.exists()) return snap.data();
        return { activities: [], dailyTasks: {} };
      };

      // リアルタイム購読
      window.subscribeData = function(userId, cb) {
        const uid = ensureUserId(userId);
        const ref = doc(db, "users", uid);
        return onSnapshot(ref, (snap) => {
          if (snap.exists()) cb(snap.data());
        }, (err) => console.error("onSnapshot error:", err));
      };
    </script>


    <!-- あなたのアプリ本体 -->
    <script src="app.js"></script>
  </body>
</html>
